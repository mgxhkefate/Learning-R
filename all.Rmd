---
title: "all"
author: "mgxhkefate"
date: "2025-12-04"
output: html_document
---

```{R globel setting of code chunks}
# the global setting of code chunks
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, include=FALSE)
```

本文档用于总览 [mgxh-publish-md](https://github.com/mgxhkefate/mgxh-publish-md) 项目中的所有 R 代码，具体笔记与 [发布的 github page](https://mgxhkefate.github.io/mgxh-publish-md/) 上的内容一致，但是只有这里存储了完整的代码。

## Structural Equation Model, SEM

> 完整代码见：SEM.R

结构方程模型 (SEM) 通常被用于探索潜变量与观察变量、潜变量之间的关系，前者组成了 SEM 的测量模型，后者则组成了 SEM 的路径模型。使用 R 进行 SEM 主要用到 `lavaan` 包，而画图可以采用 `semPlot` 包。

本次练习使用的数据来自 Copilot 写的一个 python 脚本，当然也可以使用 lavaan 包内置的数据集，e.g., PoliticalDemocracy.

```{r loading data}
data <- read.csv("./project/sem/data/raw/sem_synthetic.csv")
```

```{r loading R package}
# install.packages("lavaan")
# install.packages("semPlot")
library(lavaan)
library(semPlot)
```

### 1. 模型定义

采用 `A =~ a1 + a2` 定义测量模型，即哪些观察变量被某个潜变量解释。

```{r measure model}
model <- ' 
  Extraversion =~ ext_it1 + ext_it2 + ext_it3 + ext_it4
  Neuroticism =~ neu_it1 + neu_it2 + neu_it3 + neu_it4
  Conscientiousness =~ con_it1 + con_it2 + con_it3 + con_it4
'
```

采用 `A ~ B` 定义路径模型 (对应$B \rightarrow A$)，即

```{r the path model}
model <- ' 
  Extraversion =~ ext_it1 + ext_it2 + ext_it3 + ext_it4
  Neuroticism =~ neu_it1 + neu_it2 + neu_it3 + neu_it4
  Conscientiousness =~ con_it1 + con_it2 + con_it3 + con_it4
  
  Extraversion ~ Neuroticism
'
```

使用 `A ~~ B` 定义相关关系，不过通常情况下 lavaan 包会自动建立外生潜变量之间的相关，不需要再手动指定。

```{r the correlation}
model <- ' 
  Extraversion =~ ext_it1 + ext_it2 + ext_it3 + ext_it4
  Neuroticism =~ neu_it1 + neu_it2 + neu_it3 + neu_it4
  Conscientiousness =~ con_it1 + con_it2 + con_it3 + con_it4
  
  Extraversion ~ Neuroticism
  Extraversion ~~ Conscientiousness 
'
```

定义完模型后我们就可以使用 lavaan 包里的 `sem` 函数进行模型拟合了，最后使用 `summary` 函数来输出完整的结果。

```{r echo=TRUE}
fit <- sem(model, data)
# summary(fit, standardize = TRUE)
summary(fit)
```

### 2. 绘制结构方程图

如果已经载入了 semPlot 包，就可以使用其中的 `semPaths` 函数绘制初步的结构方程图了，此处图中线上的标签为标准化的回归系数。

```{r loading, echo=TRUE}
semPaths(fit, "std", layout="tree", edge.label.cex = 1.2)
```

### 3. 查看模型拟合指标

模型拟合完我们需要判断模型拟合程度是怎样的，就需要使用 lavaan 包里的 `fitmeasures` 函数来查看，此处输出了所有的拟合指数。

```{r model fit indices}
model_indices <- fitmeasures(fit, fit.measures = "all")
model_indices
```

### 4. 查看模型修正指数

如果模型拟合效果较差，我们就需要根据修正指数来调整模型，并重复上述步骤。使用 lavaan 包的 modindices 函数输出修正指数。

```{r modified indices}
modindices(fit)
```

```{r save RData and img}
# 保存模型拟合数据
save(fit,file = "./project/sem/data/processed/fit.RData")

# 打开图片设备
png(filename = "./project/sem/output/fit.png",
    width = 30, height = 20, units = "in",
    res = 330)

semPaths(fit, "std", layout="tree", edge.label.cex = 1.2)

# 关闭设备
dev.off()
```





## Network analysis, NA

网络分析 (NA) 用于同时分析多个观察变量之间的关系，主要用于找到“最重要的变量”以及网络之间的关系。NA 通常包含查看中心性指标与稳定性 (可靠性) 检验，在目前的研究中还会加上桥梁分析，检验桥中心性指标与其稳定性。

要注意的是，不同类型的网络需要使用不同的网络拟合。本次演示使用的是连续变量，数据来自 `psych` 包的 `bfi` 。**横断面单一连续变量网络分析** 主要采用 `bootNet` 包、`qgraph` 包。如果要进行额外的桥梁分析，则需要借助 `networktools` 包

演示数据为 psych 包的 bfi 的前25个题项。

```{r loading data}
# install.packages("psych")
# install.packages("bootnet")
# install.packages("qgraph")
# install.packages("networktools")
library(psych)
library(bootnet)
library(qgraph)
library(ggplot2)
library(networktools)

bfi_clean <- na.omit(bfi[, 1:25]) # 删除带有 NA 值的数据行
```

### 1. 定义网络

主要要设置一下组 (group) / 社区 (community)，即哪些变量归属于哪个量表。如果还想要显示每题的内容，那就要设置其 nodename (label 可以设置也可以不设置，默认变量名)。

```{r config network}
comm_labels <- c(
  rep("Agreeableness", 5),    # A1-A5
  rep("Conscientiousness", 5),# C1-C5
  rep("Extraversion", 5),     # E1-E5
  rep("Neuroticism", 5),      # N1-N5
  rep("Openness", 5)          # O1-O5
)

names(comm_labels) <- colnames(bfi_clean)
```

#### 1.1. 计算可预测性
主要使用 `mgm` 函数进行矩阵计算，再使用 `predict()` 来输出预测拟合优度矩阵，最后提取出可预测性。

```{r predict}
install.packages("mgm")
library(mgm)
network <- as.matrix(bfi_clean)
p <- ncol(network)
fit_obj <- mgm(data = network, 
              type = rep("g", p),  # "g"表示高斯（连续）变量
              level = rep(1, p),   # 对于连续变量设为1
              lambdaSel = "CV",    # 使用交叉验证选择lambda
              ruleReg = "OR",      # 正则化规则
              pbar = TRUE)        # 打开进度条
pred_obj <- predict(object = fit_obj,
                    data = network,
                    errorCon = 'R2')
pred_obj$error
```


### 2. 网络估计

该步骤主要使用 `estimateNetwork()` 进行网络估计并使用 `plot()` 生成网络图。

```{r network estimate}
net_bfi <- estimateNetwork(
  bfi_clean,
  default = "EBICglasso",
  tuning = 0.5,
  corMethod = "cor_auto"
)

png(filename = "./project/na/output/network.png",
    width = 16, height = 9, units = "in",
    res = 330)
plot(net_bfi,layout = "spring", groups = comm_labels,
     label.cex = 0.7, label.color = 'black',
     legend=F,
     legend.cex = 0.45, # 图例的字体大小
     legend.mode = 'style1', # 图例的风格，默认是'style1'
     )
dev.off()
```

#### 2.1. 带有可预测性的网络图
```{r predict network plot}
png(filename = "./project/na/output/network_predict.png",
    width = 16, height = 9, units = "in",
    res = 330)
plot_network <- plot(net_bfi,
                     layout = "spring",
                     groups = comm_labels,
                     label.cex = 1,
                     label.color = 'black',
                     negDashed = T,
                     legend=F,
                     #nodeNames = items,
                     legend.cex = 0.32,
                     legend.mode = 'style1',
                     pie = pred_obj$error[,2])
dev.off()
```


### 3. 计算中心性指标

使用 qgraph 包里的 `centralityPlot()` 计算中心性指标，主要包括 Strength, closeness, Betweenness and ExpectedInfluence，输出图中的分数为 z 分数。

```{r centrality indices}
png(filename = "./project/na/output/centrality.png",
    width = 16, height = 9, units = "in",
    res = 330)
centralityPlot(net_bfi, include = "all", 
               orderBy = "ExpectedInfluence", scale = c("z-scores"))
dev.off()
# centrality_auto(net_bfi)
```

### 4. 中心性指标的稳定性检验

#### 4.1. 非参 bootstrap

使用 bootNet 包的 `bootnet()` 进行非参 bootstrap 检验边权重的稳定性，并且进行差异检验(使用 `plot(xx,plot="difference")`，生成指定的差异图)。

```{r bootstrap}
boot_net <- bootnet(net_bfi,
                    nBoots = 100,
                    nCores = 8,
                    statistics = c('strength','expectedInfluence',
                                   'betweenness','closeness',"edge"))
```

```{r plot}
png(filename = "./project/na/output/boot_net-edge.png",
    width = 16, height = 9, units = "in",
    res = 330)
plot(boot_net,
     labels = FALSE,
     order = "sample")
dev.off()

png(filename = "./project/na/output/boot_net-strength.png",
    width = 16, height = 9, units = "in",
    res = 330)
plot(boot_net,"strength",plot = "difference")
dev.off()

png(filename = "./project/na/output/boot_net-edge.png",
    width = 16, height = 9, units = "in",
    res = 330)
plot(boot_net,"edge",plot = "difference")
dev.off()
```

#### 4.2. case-drop bootstrap

通过 `bootnet(xx, type="case")`指定非参bootstrap法，使用非参 case-drop bootstrap 检验中心性指标的稳定性以及各指标随着 case-drop 率变化的折线图。

```{r case-drop bootstrap}
case_drop_boot_net <- bootnet(net_bfi,
                              nBoots = 100,
                              nCores = 8,
                              type = "case",
                              statistics = c('strength',
                                             'expectedInfluence',
                                             'betweenness',
                                             'closeness',"edge"))
```

并且使用 bootNet 包里的 `corStability()` 来输出稳定性系数。

```{r plot}
png(filename = "./project/na/output/case_drop_boot_net.png",
    width = 16, height = 9, units = "in",
    res = 330)
plot(case_drop_boot_net, 'all')
corStability(case_drop_boot_net)
dev.off()
```

```{r save}
save(net_bfi, file = "./project/na/data/processed/net_bfi.RData")
save(boot_net, file = "./project/na/data/processed/boot_net.RData")
save(case_drop_boot_net, file = "./project/na/data/processed/case_drop_boot_net.RData")
```

### 5. 桥中心性指标

使用 networktools 包的 `bridge()` 计算桥中心性指标。

```{r bridge_centrality}
bridge_centrality <- bridge(net_bfi$graph, communities = comm_labels)
print(bridge_centrality)
png(filename = "./project/na/output/bridge_centrality.png",
    width = 16, height = 9, units = "in",
    res = 330)
plot(bridge_centrality,order="value",zscore=T)
dev.off()
```

根据百分比求桥接节点，即从小到大排序，bridge strength 在 80% 以上的节点。

```{r bridge strength}
bridge_Strength <- bridge_centrality$`Bridge Strength`
top_bridges <- names(
  bridge_Strength[bridge_Strength>quantile(bridge_Strength,probs=0.80,
                                           na.rm=TRUE)]
  )
print(top_bridges)
```

### 5. 桥中心性指标的稳定性检验

#### 5.1. 非参bootstrap

用于检验 bridge strength 的差异。

```{r bootstrap}
boot_bridge_net <- bootnet(net_bfi, nBoots = 100, nCores = 8,
                           statistics = c("bridgeStrength"),
                           communities = comm_labels
                           )
```

```{r plot}
png(filename = "./project/na/output/boot_bridge_net-bridgeStrength.png",
    width = 16, height = 9, units = "in",
    res = 330)
plot(boot_bridge_net,"bridgeStrength",plot = "difference")
dev.off()
```
#### 5.2. case-drop bootstrap

用于输出稳定性系数、桥中心性指标随 case-drop 率变化的折线图。

```{r case-drop bootstrap}
case_boot_bridge_net <- bootnet(net_bfi, nBoots = 100, nCores = 8,
                           statistics = c("bridgeStrength"),
                           communities = comm_labels,
                           type = "case")
```

```{r}
corStability(case_boot_bridge_net)
png(filename = "./project/na/output/case_boot_bridge_net-bridgeStrength.png",
    width = 16, height = 9, units = "in",
    res = 330)
plot(case_boot_bridge_net,"bridgeStrength")
dev.off()
```

```{r save}
save(top_bridges, file = "./project/na/data/processed/top_bridges.RData")
save(boot_bridge_net, file = "./project/na/data/processed/boot_bridge_net.RData")
save(case_boot_bridge_net, file = "./project/na/data/processed/case_boot_bridge_net.RData")
```
